<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Tour ESAN 360</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <script>
      AFRAME.registerComponent('tour-logic', {
        init: function () {
          var el = this.el;
          
          el.addEventListener('click', function (evt) {
            var target = el.getAttribute('data-target');
            var rotacionFlecha = el.getAttribute('rotation');
            var anguloDestino = rotacionFlecha ? rotacionFlecha.y : 0;

            if (target && target !== "null") {
              iniciarTransicion(target, anguloDestino);
            }
          });

          el.addEventListener('mouseenter', function () {
            var current = el.getAttribute('scale');
            el.setAttribute('scale', {x: current.x * 1.2, y: current.y * 1.2, z: current.z * 1.2});
            const mesh = el.getObject3D('mesh');
            if (mesh) {
                mesh.traverse(node => { if (node.isMesh) node.material.emissive.set('#550000'); });
            }
          });

          el.addEventListener('mouseleave', function () {
            el.setAttribute('scale', '20 20 20'); 
            const mesh = el.getObject3D('mesh');
            if (mesh) {
                mesh.traverse(node => { if (node.isMesh) node.material.emissive.set('#000000'); });
            }
          });
        }
      });

      // =============================================================
      // CAMBIO IMPORTANTE 1: REFERENCIAS DIRECTAS A ARCHIVOS
      // Ya no usamos IDs (#img-...), usamos la ruta del archivo.
      // Esto evita que A-Frame intente cargar todo al inicio.
      // =============================================================
      const escenas = {
        'entrada': {
          imagen: 'imagenes/Entrada.jpeg', // Ruta directa
          flechas: [ { target: 'entrada2', position: '19.82 -1 2.64', rotation: '0 100 0' } ]
        },
        'entrada2': {
          imagen: 'imagenes/Entrada2.jpeg',
          flechas: [
            { target: 'selector1', position: '-15.31 -1 12.86', rotation: '0 -30 0' },
            { target: 'entrada', position: '17.26 -1 -10.10', rotation: '0 150 0' }
          ]
        },
        'selector1': {
          imagen: 'imagenes/Selector1.jpeg',
          flechas: [
            { target: 'pasajeServicioAcademico', position: '19.99 -1 -0.67', rotation: '0 100 0' },
            { target: 'entradaGTH', position: '-10.52 -1 -17.01', rotation: '0 -140 0' },
            { target: 'entrada2', position: '-13.28 -1 14.96', rotation: '0 -20 0' }
          ]
        },
        'pasajeServicioAcademico': {
          imagen: 'imagenes/PasajeServicioAcademico.jpeg',
          flechas: [
            { target: 'comedor2doPiso', position: '14.88 -1 13.36', rotation: '0 85 0' },
            { target: 'selector1', position: '6.66 -1 -18.86', rotation: '0 180 0' }
          ]
        },
        'comedor2doPiso': {
          imagen: 'imagenes/Comedor2doPiso.jpeg',
          flechas: [
            { target: 'edificioD', position: '-19.95 -1 1.47', rotation: '0 -40 0' },
            { target: 'pasajeServicioAcademico', position: '19.34 -1 -5.08', rotation: '0 130 0' }
          ]
        },
        'edificioD': {
          imagen: 'imagenes/EdificioD.jpeg',
          flechas: [
            { target: 'edificioA', position: '-19.21 -1 5.57', rotation: '0 -50 0' },
            { target: 'comedor2doPiso', position: '19.94 -1 -1.60', rotation: '0 130 0' }
          ]
        },
        'edificioA': {
          imagen: 'imagenes/EdificioA.jpeg',
          flechas: [
            { target: 'cafeteria', position: '18.65 -1 7.21', rotation: '0 130 0' },
            { target: 'pabellonA', position: '-18.50 -1 7.61', rotation: '0 -45 0' },
            { target: 'edificioD', position: '-7.46 -1 -18.56', rotation: '0 220 0' }
          ]
        },
        'cafeteria': {
          imagen: 'imagenes/Cafeteria.jpeg',
          flechas: [
            { target: 'explanadaConvention', position: '-8.38 -1 -18.16', rotation: '0 -125 0' },
            { target: 'edificioA', position: '6.47 -1 18.93', rotation: '0 55 0' }
          ]
        },
        'explanadaConvention': {
          imagen: 'imagenes/ExplanadaConvention.jpeg',
          flechas: [
            { target: 'cafeteria', position: '10.52 -1 -17.01', rotation: '0 180 0' }
          ]
        },
        'pabellonA': {
          imagen: 'imagenes/PabellonA.jpeg',
          flechas: [
            { target: 'edificioA', position: '-12.48 -1 15.63', rotation: '0 0 0' }
          ]
        },
        'entradaGTH': {
          imagen: 'imagenes/EntradaGTH.jpeg',
          flechas: [
            { target: 'accesoGTH', position: '-20.00 -1 0.05', rotation: '0 -65 0' },
            { target: 'selector1', position: '-0.05 -1 20.00', rotation: '0 25 0' }
          ]
        },
        'accesoGTH': {
          imagen: 'imagenes/AccesoGTH.jpeg',
          flechas: [
            { target: 'aulasAyB', position: '3.28 -1 -19.73', rotation: '0 -150 0' },
            { target: 'entradaGTH', position: '-1.37 -1 19.95', rotation: '0 35 0' }
          ]
        },
        'aulasAyB': {
          imagen: 'imagenes/AulasAyB.jpeg',
          flechas: [
            { target: 'salidaAreasVerdes', position: '-17.38 -1 9.90', rotation: '0 -30 0' },
            { target: 'accesoGTH', position: '17.33 -1 -9.97', rotation: '0 140 0' }
          ]
        },
        'salidaAreasVerdes': {
          imagen: 'imagenes/SalidaAreasVerdes.jpeg',
          flechas: [
            { target: 'entradaCapilla', position: '15.97 -1 -12.04', rotation: '0 150 0' },
            { target: 'aulasAyB', position: '10.72 -1 16.89', rotation: '0 50 0' }
          ]
        },
        'entradaCapilla': {
          imagen: 'imagenes/EntradaCapilla.jpeg',
          flechas: [
            { target: 'salidaAreasVerdes', position: '1.92 -1 -19.91', rotation: '0 180 0' }
          ]
        }
      };

      function iniciarTransicion(nombreEscena, anguloDestino) {
        var datos = escenas[nombreEscena];
        var contenedorFlechas = document.querySelector('#flechas-container');
        var cieloFondo = document.querySelector('#cielo-fondo'); 
        var cieloFrente = document.querySelector('#cielo-frente');
        var rig = document.querySelector('#rig');
        var cam = document.querySelector('#camara-principal');
        
        var duracionTransicion = 1000;

        contenedorFlechas.setAttribute('visible', 'false');

        // Efecto Zoom
        cam.setAttribute('animation', {property: 'fov', from: 80, to: 75, dur: 300, easing: 'easeOutQuad'});

        // Asignar nueva imagen (se carga en este momento)
        cieloFrente.setAttribute('src', datos.imagen);
        
        cieloFrente.setAttribute('animation__fade', {
            property: 'material.opacity',
            from: 0, to: 1, dur: duracionTransicion, easing: 'easeInOutQuad'
        });

        // Giro suave forzado
        rig.setAttribute('animation__rotacion', {
            property: 'rotation',
            to: `0 ${anguloDestino} 0`,
            dur: duracionTransicion,
            easing: 'easeInOutQuad'
        });

        setTimeout(() => {
            cieloFondo.setAttribute('src', datos.imagen);
            cieloFrente.removeAttribute('animation__fade');
            cieloFrente.setAttribute('material', 'opacity', 0);
            
            // Importante: Liberar memoria de la imagen anterior si es posible
            // (A-Frame lo maneja internamente, pero el cambio de src ayuda)
            
            rig.removeAttribute('animation__rotacion');

            generarFlechas(datos.flechas);
            contenedorFlechas.setAttribute('visible', 'true');
            cam.setAttribute('animation', {property: 'fov', to: 80, dur: 500});
            
        }, duracionTransicion + 50);
      }

      function generarFlechas(listaFlechas) {
        var contenedor = document.querySelector('#flechas-container');
        contenedor.innerHTML = '';
        
        listaFlechas.forEach(flecha => {
          var entidad = document.createElement('a-entity');
          entidad.setAttribute('gltf-model', '#modelo-flecha');
          entidad.setAttribute('scale', '20 20 20'); 
          entidad.setAttribute('position', flecha.position);
          entidad.setAttribute('rotation', `0 ${parseRotation(flecha.rotation)} 0`); 
          
          entidad.addEventListener('model-loaded', function(){
             const obj = entidad.getObject3D('mesh');
             if (!obj) return;
             obj.traverse(node => {
                if (node.isMesh) {
                   node.material.color.set('#FF0000');
                   node.material.needsUpdate = true;
                }
             });
          });
          
          entidad.setAttribute('data-target', flecha.target);
          entidad.setAttribute('class', 'clickable'); 
          entidad.setAttribute('tour-logic', ''); 
          
          contenedor.appendChild(entidad);
        });
      }

      function parseRotation(rotString) {
        if(!rotString) return 0;
        return parseFloat(rotString.split(' ')[1]) || 0;
      }

      // Pre-cargar solo la imagen inicial
      window.onload = function() { 
        var datos = escenas['entrada'];
        document.querySelector('#cielo-fondo').setAttribute('src', datos.imagen);
        generarFlechas(datos.flechas);
      };
    </script>
  </head>
  
  <body>
    <a-scene 
      renderer="antialias: false; colorManagement: true; sortObjects: true; precision: mediump;"
      cursor="rayOrigin: mouse" 
      raycaster="objects: .clickable">
      
      <a-assets timeout="10000">
        <a-asset-item id="modelo-flecha" src="imagenes/flecha.glb"></a-asset-item>
        <img id="img-entrada-preload" src="imagenes/Entrada.jpeg"> 
      </a-assets>

      <a-sky id="cielo-fondo" radius="500" rotation="0 -90 0"></a-sky>
      <a-sky id="cielo-frente" radius="490" rotation="0 -90 0" material="opacity: 0; transparent: true"></a-sky>

      <a-light type="ambient" color="#FFF" intensity="1.5"></a-light>
      <a-entity id="flechas-container"></a-entity>

      <a-entity id="rig" position="0 1.6 0" rotation="0 0 0">
        <a-camera id="camara-principal" fov="80" wasd-controls-enabled="false" look-controls="reverseMouseDrag: true"></a-camera>
        <a-entity laser-controls="hand: right" raycaster="objects: .clickable; lineColor: #FF0000; lineOpacity: 0.7"></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
